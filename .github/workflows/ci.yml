name: Continuous Integration
on: 
  workflow_dispatch:
  push:
    branches:
     - master
     - 1.9-dev
  pull_request:
    branches:
     - master
     - 1.9-dev

jobs:
  test:
    strategy:
      matrix:
        include:
          # Ubuntu 22.04 with Clang 11 - Standard Metamod
          - os: ubuntu-22.04
            os_short: linux
            compiler_cc: clang-11
            compiler_cxx: clang++-11
            metamod_variant: standard
            metamod_repo: https://github.com/alliedmodders/metamod-hl1
            
          # Ubuntu 22.04 with Clang 11 - Metamod-R (ReHLDS)
          - os: ubuntu-22.04
            os_short: linux
            compiler_cc: clang-11
            compiler_cxx: clang++-11
            metamod_variant: rehlds
            metamod_repo: https://github.com/rehlds/Metamod-R
            
          # Ubuntu 22.04 with GCC 9 - Standard
          - os: ubuntu-22.04
            os_short: linux
            compiler_cc: gcc-9
            compiler_cxx: g++-9
            compiler_install: 'gcc-9-multilib g++-9-multilib'
            metamod_variant: standard
            metamod_repo: https://github.com/alliedmodders/metamod-hl1
            
          # Ubuntu 24.04 with GCC 11 - ReHLDS (Debian 13+ compatible)
          - os: ubuntu-24.04
            os_short: linux
            compiler_cc: gcc-11
            compiler_cxx: g++-11
            compiler_install: 'gcc-11-multilib g++-11-multilib'
            metamod_variant: rehlds
            metamod_repo: https://github.com/rehlds/Metamod-R
            
      fail-fast: false
      
    runs-on: ${{ matrix.os }}
    name: ${{ matrix.os_short }}-${{ matrix.compiler_cc }}-${{ matrix.metamod_variant }}
    
    env:
      DEPENDENCIES_FOLDER: dependencies      
      DEPENDENCIES_ROOT: ${{ github.workspace }}/dependencies      
      DEPENDENCIES_ROOT_WIN: ${{ github.workspace }}\dependencies              
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: amxmodx
          
      # Setup Python for AMBuild
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          python3 --version
          
      - name: Verify source code fixes
        working-directory: amxmodx
        run: |
          echo "Checking for required fixes..."
          
          # Check if C++14 is set
          if ! grep -q "'-std=c++14'" AMBuildScript; then
            echo "ERROR: AMBuildScript still uses C++11. Please apply fixes first!"
            echo "Run: sed -i \"s/'-std=c++11'/'-std=c++14'/g\" AMBuildScript"
            exit 1
          fi
          
          # Check if am-autoptr.h include is removed
          if grep -q "am-autoptr.h" amxmodx/CPlugin.h 2>/dev/null; then
            echo "ERROR: CPlugin.h still includes am-autoptr.h. Please apply fixes first!"
            echo "Run: sed -i '/am-autoptr\\.h/d' amxmodx/CPlugin.h"
            exit 1
          fi
          
          # Check NS module fixes (only if files exist)
          if [ -f "modules/ns/GameManager.h" ]; then
            if grep -q "ke::AString" modules/ns/GameManager.h; then
              echo "ERROR: GameManager.h still uses ke::AString. Please apply fixes first!"
              echo "Run: sed -i 's/ke::AString/AString/g' modules/ns/GameManager.h"
              exit 1
            fi
          fi
          
          if [ -f "modules/ns/ParticleManager.h" ]; then
            if grep -q "ke::AString\|ke::Vector" modules/ns/ParticleManager.h; then
              echo "ERROR: ParticleManager.h still uses ke:: namespace. Please apply fixes first!"
              echo "Run: sed -i 's/ke::AString/AString/g; s/ke::Vector/Vector/g' modules/ns/ParticleManager.h"
              exit 1
            fi
          fi
          
          echo "âœ“ All required fixes are in place"
          
      - name: Install Linux dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            gcc-multilib g++-multilib libstdc++6 lib32stdc++6 \
            libc6-dev libc6-dev-i386 linux-libc-dev \
            linux-libc-dev:i386 lib32z1-dev nasm \
            ${{ matrix.compiler_cc }} ${{ matrix.compiler_install || matrix.compiler_cxx }}
            
      - name: Select compiler
        run: |
          echo "CC=${{ matrix.compiler_cc }}" >> $GITHUB_ENV
          echo "CXX=${{ matrix.compiler_cxx }}" >> $GITHUB_ENV
          echo "Compiler versions:"
          ${{ matrix.compiler_cc }} --version
          ${{ matrix.compiler_cxx }} --version
          
      - name: Install AMXModX dependencies (Linux)
        shell: bash
        run: |
          mkdir -p ${{ env.DEPENDENCIES_FOLDER }}
          cd ${{ env.DEPENDENCIES_FOLDER }}
          
          # Satisfy checkout-deps requirement for a "amxmodx" folder
          mkdir -p amxmodx
          
          # Clone metamod based on variant
          if [ "${{ matrix.metamod_variant }}" = "rehlds" ]; then
            echo "Using Metamod-R for ReHLDS testing"
            git clone ${{ matrix.metamod_repo }} metamod-r-temp
            # Metamod-R has headers in metamod/src/, need to restructure
            mkdir -p metamod-am/metamod
            cp -r metamod-r-temp/metamod/src/* metamod-am/metamod/
            cp -r metamod-r-temp/metamod/extra metamod-am/metamod/ 2>/dev/null || true
            rm -rf metamod-r-temp
          else
            echo "Using standard AlliedModders Metamod"
            git clone ${{ matrix.metamod_repo }} metamod-am
          fi
          
          # Clone other dependencies
          echo "Cloning HLSDK..."
          git clone --depth=1 https://github.com/alliedmodders/hlsdk
          
          echo "Cloning AMBuild..."
          git clone --depth=1 https://github.com/alliedmodders/ambuild
          
          cd ambuild
          python3 setup.py install --user
          cd ..
          
          # Download MySQL
          echo "Downloading MySQL 5.5..."
          curl -L -o "mysql-5.5.57-linux-glibc2.12-i686.tar.gz" \
            http://cdn.mysql.com/archives/mysql-5.5/mysql-5.5.57-linux-glibc2.12-i686.tar.gz
          tar zxf mysql-5.5.57-linux-glibc2.12-i686.tar.gz
          mv mysql-5.5.57-linux-glibc2.12-i686 mysql-5.5
          
          echo "Dependencies installed successfully"
          
      - name: Setup NASM
        uses: ilammy/setup-nasm@v1
        
      - name: Build
        working-directory: amxmodx
        run: |
          mkdir build
          cd build
          
          echo "Configuring build..."
          python3 ../configure.py \
            --enable-optimize \
            --metamod=${{ env.DEPENDENCIES_ROOT }}/metamod-am \
            --hlsdk=${{ env.DEPENDENCIES_ROOT }}/hlsdk \
            --mysql=${{ env.DEPENDENCIES_ROOT }}/mysql-5.5
            
          echo "Starting build..."
          ambuild
          
          echo "Build completed successfully!"
          
      - name: Verify build output
        working-directory: amxmodx/build
        run: |
          echo "Checking build output..."
          
          if [ ! -d "packages" ]; then
            echo "ERROR: packages directory not found!"
            exit 1
          fi
          
          echo "Build packages created:"
          ls -lah packages/
          
      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: amxmodx-${{ matrix.metamod_variant }}-${{ matrix.os_short }}-${{ matrix.compiler_cc }}-${{ github.sha }}
          path: amxmodx/build/packages/
          retention-days: 7
          
      - name: Build summary
        if: success()
        run: |
          echo "::notice::Build successful for ${{ matrix.compiler_cc }} (${{ matrix.metamod_variant }})"
