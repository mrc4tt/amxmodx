name: Build and Release AMX Mod X
on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - stable
  push:
    tags:
      - 'v*'
  schedule:
    # Run weekly dev builds every Monday at 00:00 UTC
    - cron: '0 0 * * 1'

env:
  BUILD_TYPE: Release
  DEPENDENCIES_FOLDER: dependencies
  DEPENDENCIES_ROOT: ${{ github.workspace }}/dependencies

jobs:
  build:
    name: Build ${{ matrix.os_short }}-${{ matrix.compiler_cc }}-${{ matrix.metamod_variant }}
    strategy:
      matrix:
        include:
          # Standard Metamod builds (AlliedModders)
          - os: ubuntu-22.04
            os_short: linux
            compiler_cc: clang-11
            compiler_cxx: clang++-11
            metamod_variant: standard
            metamod_repo: https://github.com/alliedmodders/metamod-hl1
            metamod_branch: master
          - os: ubuntu-24.04
            os_short: linux
            compiler_cc: gcc-11
            compiler_cxx: g++-11
            compiler_install: 'gcc-11-multilib g++-11-multilib'
            metamod_variant: standard
            metamod_repo: https://github.com/alliedmodders/metamod-hl1
            metamod_branch: master
          # ReHLDS-optimized builds (Metamod-R)
          - os: ubuntu-22.04
            os_short: linux
            compiler_cc: clang-11
            compiler_cxx: clang++-11
            metamod_variant: rehlds
            metamod_repo: https://github.com/rehlds/Metamod-R
            metamod_branch: master
          - os: ubuntu-24.04
            os_short: linux
            compiler_cc: gcc-11
            compiler_cxx: g++-11
            compiler_install: 'gcc-11-multilib g++-11-multilib'
            metamod_variant: rehlds
            metamod_repo: https://github.com/rehlds/Metamod-R
            metamod_branch: master
      fail-fast: false
    runs-on: ${{ matrix.os }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      git_commit_count: ${{ steps.version.outputs.git_commit_count }}
    
    steps:
      - name: Checkout AMX Mod X
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          path: amxmodx

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip setuptools wheel

      - name: Generate version
        id: version
        shell: bash
        working-directory: amxmodx
        run: |
          PRODUCT_VERSION=$(cat product.version)
          GIT_COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION="${PRODUCT_VERSION}-${GIT_COMMIT_COUNT}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "git_commit_count=${GIT_COMMIT_COUNT}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Install Linux dependencies (Ubuntu 22.04/24.04)
        if: startsWith(runner.os, 'Linux')
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            gcc-multilib g++-multilib libstdc++6 lib32stdc++6 \
            libc6-dev libc6-dev-i386 linux-libc-dev \
            linux-libc-dev:i386 lib32z1-dev nasm \
            ${{ matrix.compiler_cc }} ${{ matrix.compiler_install || matrix.compiler_cc }}

      - name: Setup compiler environment (Linux)
        if: startsWith(runner.os, 'Linux')
        run: |
          echo "CC=${{ matrix.compiler_cc }}" >> $GITHUB_ENV
          echo "CXX=${{ matrix.compiler_cxx }}" >> $GITHUB_ENV
          ${{ matrix.compiler_cc }} --version
          ${{ matrix.compiler_cxx }} --version

      - name: Install AMX Mod X dependencies (Linux)
        if: startsWith(runner.os, 'Linux')
        shell: bash
        run: |
          mkdir -p ${{ env.DEPENDENCIES_FOLDER }}
          cd ${{ env.DEPENDENCIES_FOLDER }}
          mkdir -p amxmodx
          
          # Clone metamod based on variant
          if [ "${{ matrix.metamod_variant }}" = "rehlds" ]; then
            echo "Cloning Metamod-R for ReHLDS optimized build"
            git clone ${{ matrix.metamod_repo }} -b ${{ matrix.metamod_branch }} metamod-r-temp
            # Metamod-R has headers in metamod/src/, need to restructure
            mkdir -p metamod-am/metamod
            cp -r metamod-r-temp/metamod/src/* metamod-am/metamod/
            cp -r metamod-r-temp/metamod/extra metamod-am/metamod/ 2>/dev/null || true
            rm -rf metamod-r-temp
          else
            echo "Cloning standard AlliedModders Metamod"
            git clone ${{ matrix.metamod_repo }} -b ${{ matrix.metamod_branch }} metamod-am
          fi
          
          # Clone other dependencies
          git clone https://github.com/alliedmodders/hlsdk
          git clone https://github.com/alliedmodders/ambuild
          
          # Install AMBuild
          cd ambuild
          python3 setup.py install --user
          cd ..
          
          # Download MySQL
          curl -L -o "mysql-5.5.57-linux-glibc2.12-i686.tar.gz" http://cdn.mysql.com/archives/mysql-5.5/mysql-5.5.57-linux-glibc2.12-i686.tar.gz
          tar zxf mysql-5.5.57-linux-glibc2.12-i686.tar.gz
          mv mysql-5.5.57-linux-glibc2.12-i686 mysql-5.5

      - name: Setup NASM
        uses: ilammy/setup-nasm@v1

      - name: Build
        working-directory: amxmodx
        run: |
          mkdir build
          cd build
          python3 ../configure.py --enable-optimize \
            --metamod=${{ env.DEPENDENCIES_ROOT }}/metamod-am \
            --hlsdk=${{ env.DEPENDENCIES_ROOT }}/hlsdk \
            --mysql=${{ env.DEPENDENCIES_ROOT }}/mysql-5.5
          ambuild

      - name: Create version file
        shell: bash
        run: |
          echo "${{ steps.version.outputs.version }}" > amxmodx/build/product.version

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: amxmodx-${{ steps.version.outputs.version }}-${{ matrix.metamod_variant }}-${{ matrix.os_short }}-${{ matrix.compiler_cc }}
          path: |
            amxmodx/build/packages/
            amxmodx/build/product.version
          retention-days: 30

  create-release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts/

      - name: Prepare release files
        run: |
          mkdir -p release/standard release/rehlds
          cd artifacts
          
          # Process standard metamod builds
          for dir in amxmodx-*-standard-*; do
            if [ -d "$dir" ]; then
              echo "Processing standard build: $dir"
              if [ -d "$dir/packages" ]; then
                for pkg_dir in "$dir/packages/"*; do
                  if [ -d "$pkg_dir" ]; then
                    pkg_name=$(basename "$pkg_dir")
                    # Find package files
                    find "$pkg_dir" -name "*.tar.gz" -o -name "*.zip" | while read file; do
                      filename=$(basename "$file")
                      cp "$file" "../release/standard/$filename" 2>/dev/null || true
                    done
                  fi
                done
              fi
            fi
          done
          
          # Process ReHLDS metamod builds
          for dir in amxmodx-*-rehlds-*; do
            if [ -d "$dir" ]; then
              echo "Processing ReHLDS build: $dir"
              if [ -d "$dir/packages" ]; then
                for pkg_dir in "$dir/packages/"*; do
                  if [ -d "$pkg_dir" ]; then
                    pkg_name=$(basename "$pkg_dir")
                    # Find package files and rename with -rehlds suffix
                    find "$pkg_dir" -name "*.tar.gz" | while read file; do
                      filename=$(basename "$file")
                      newname=$(echo "$filename" | sed 's/\.tar\.gz$/-rehlds.tar.gz/')
                      cp "$file" "../release/rehlds/$newname" 2>/dev/null || true
                    done
                    find "$pkg_dir" -name "*.zip" | while read file; do
                      filename=$(basename "$file")
                      newname=$(echo "$filename" | sed 's/\.zip$/-rehlds.zip/')
                      cp "$file" "../release/rehlds/$newname" 2>/dev/null || true
                    done
                  fi
                done
              fi
            fi
          done
          
          cd ..
          echo "Standard packages:"
          ls -lah release/standard/
          echo "ReHLDS packages:"
          ls -lah release/rehlds/

      - name: Get version info
        id: version_info
        run: |
          # Try to get version from artifact
          VERSION_FILE=$(find artifacts -name "product.version" | head -1)
          if [ -f "$VERSION_FILE" ]; then
            VERSION=$(cat "$VERSION_FILE")
          else
            VERSION="${{ needs.build.outputs.version }}"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}"
          
          # Determine if this is a stable or dev release
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            echo "release_type=stable" >> $GITHUB_OUTPUT
            echo "Release type: stable (tagged release)"
          else
            echo "release_type=dev" >> $GITHUB_OUTPUT
            echo "Release type: dev (development build)"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version_info.outputs.release_type == 'stable' && github.ref_name || format('dev-{0}', steps.version_info.outputs.version) }}
          name: ${{ steps.version_info.outputs.release_type == 'stable' && format('AMX Mod X {0}', steps.version_info.outputs.version) || format('AMX Mod X Dev Build {0}', steps.version_info.outputs.version) }}
          body: |
            # AMX Mod X ${{ steps.version_info.outputs.release_type == 'stable' && 'Release' || 'Development Build' }}
            
            **Version:** ${{ steps.version_info.outputs.version }}
            **Build Date:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}
            
            ## Downloads
            
            ### Standard Build (AlliedModders Metamod)
            Compatible with standard HLDS and general use.
            
            **Base Package:**
            - **amxmodx-${{ steps.version_info.outputs.version }}-base-linux.tar.gz** - Linux Base Package
            
            **Counter-Strike Addon:**
            - **amxmodx-${{ steps.version_info.outputs.version }}-cstrike-linux.tar.gz** - Linux Counter-Strike Package
            
            ### ReHLDS Optimized Build (Metamod-R)
            Recommended for servers running ReHLDS (API 3.1+). Includes JIT compiler optimizations.
            
            **Base Package:**
            - **amxmodx-${{ steps.version_info.outputs.version }}-base-linux-rehlds.tar.gz** - Linux Base Package (ReHLDS)
            
            **Counter-Strike Addon:**
            - **amxmodx-${{ steps.version_info.outputs.version }}-cstrike-linux-rehlds.tar.gz** - Linux CS Package (ReHLDS)
            
            ### Other Game Addons
            Additional game-specific packages are available in both standard and ReHLDS variants.
            
            
            **Counter-Strike Addon:**
            - **amxmodx-${{ steps.version_info.outputs.version }}-cstrike-linux.tar.gz** - Linux
            
            **Steps:**
            1. Download the base package for your platform and metamod variant
            2. Download the matching game-specific addon (e.g., cstrike for Counter-Strike)
            3. Extract both to your game's mod directory
            
            **Note**: Do not mix standard and ReHLDS packages. Use matching variants.
            
            ## Changes
            
            ${{ github.event.head_commit.message || 'Automated build' }}
            
            ---
            
            ${{ steps.version_info.outputs.release_type == 'dev' && '⚠️ **This is a development build** - Use at your own risk. For stable releases, use tagged versions.' || '' }}
          files: |
            release/standard/*
            release/rehlds/*
          draft: false
          prerelease: ${{ steps.version_info.outputs.release_type == 'dev' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
